I = double(imread('purple_stp.jpg'));

w = 10;
max_I  = zeros(size(I,1)/w,size(I,2)/w,size(I,3));
min_I  = zeros(size(I,1)/w,size(I,2)/w,size(I,3));
mean_I = zeros(size(I,1)/w,size(I,2)/w,size(I,3));
sig_I  = zeros(size(I,1)/w,size(I,2)/w,size(I,3));
for i = 0:size(max_I,1)-1
    for j = 0:size(max_I,2)-1
        aux = I(w*i+1:w*i+w,w*j+1:w*j+w,:);
        max_I (i+1,j+1,:) = max (max (aux));
        min_I (i+1,j+1,:) = min (min (aux));
        mean_I(i+1,j+1,:) = mean(mean(aux));
        sig_I (i+1,j+1,:) = sqrt(mean(mean(power(aux-mean_I(i+1,j+1,:),2))));
    end
end

X = [];
for i = 1:size(max_I,1)
    for j = 1:size(max_I,2)
        aux = [max_I(i,j,:),min_I(i,j,:),mean_I(i,j,:)];
        X = [X;aux];
    end
end

k = 5;
d = 3;

[Y,idxNN] = lle(X,k,d);

G = sparse(size(X,1));
for i = 1:size(X,1)
    G(i,idxNN(i,:)) = 1;
    G(idxNN(i,:),i) = 1;
end

figure;
spy(G);

figure;
scatter3(Y(:,1),Y(:,2),Y(:,3),12,1+C);
hold on;
for i = 1:size(X,1)
    disp(i);
    for j = 1:k
        l = line([Y(i,1);Y(idxNN(i,j),1)],[Y(i,2);Y(idxNN(i,j),2)],[Y(i,3);Y(idxNN(i,j),3)]);
        l.LineStyle = '--';
        l.Color = [0.75,0.75,0.75];
    end
end
hold off;